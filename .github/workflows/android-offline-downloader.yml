name: Android Offline Downloader

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  download-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create download directory
        run: mkdir -p downloads

      # JDK 17 Download
      - name: Download JDK 17
        run: |
          echo "Downloading JDK 17..."
          curl -L -o downloads/jdk-17.zip \
            "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.13%2B11/OpenJDK17U-jdk_x64_windows_hotspot_17.0.13_11.zip"

      - name: Validate JDK 17
        run: |
          echo "Validating JDK 17..."
          file_size=$(stat -c%s downloads/jdk-17.zip)
          if [ $file_size -lt 100000000 ]; then
            echo "ERROR: JDK file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/jdk-17.zip > /dev/null 2>&1; then
            echo "ERROR: JDK ZIP integrity check failed"
            exit 1
          fi
          echo "JDK 17 validation passed"

      - name: Upload JDK 17
        uses: actions/upload-artifact@v4
        with:
          name: jdk-17
          path: downloads/jdk-17.zip

      # Gradle Download
      - name: Download Gradle 8.0.2
        run: |
          echo "Downloading Gradle 8.0.2..."
          curl -L -o downloads/gradle-8.0.2.zip \
            "https://services.gradle.org/distributions/gradle-8.0.2-bin.zip"

      - name: Validate Gradle
        run: |
          echo "Validating Gradle..."
          file_size=$(stat -c%s downloads/gradle-8.0.2.zip)
          if [ $file_size -lt 50000000 ]; then
            echo "ERROR: Gradle file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/gradle-8.0.2.zip > /dev/null 2>&1; then
            echo "ERROR: Gradle ZIP integrity check failed"
            exit 1
          fi
          echo "Gradle validation passed"

      - name: Upload Gradle
        uses: actions/upload-artifact@v4
        with:
          name: gradle-8.0.2
          path: downloads/gradle-8.0.2.zip

      # Command Line Tools Download
      - name: Download Command Line Tools
        run: |
          echo "Downloading Android Command Line Tools..."
          curl -L -o downloads/commandlinetools-win-latest.zip \
            "https://dl.google.com/android/repository/commandlinetools-win-latest.zip"

      - name: Validate Command Line Tools
        run: |
          echo "Validating Command Line Tools..."
          file_size=$(stat -c%s downloads/commandlinetools-win-latest.zip)
          if [ $file_size -lt 50000000 ]; then
            echo "ERROR: Command Line Tools file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/commandlinetools-win-latest.zip > /dev/null 2>&1; then
            echo "ERROR: Command Line Tools ZIP integrity check failed"
            exit 1
          fi
          echo "Command Line Tools validation passed"

      - name: Upload Command Line Tools
        uses: actions/upload-artifact@v4
        with:
          name: commandlinetools-win-latest
          path: downloads/commandlinetools-win-latest.zip

      # Platform Tools Download
      - name: Download Platform Tools
        run: |
          echo "Downloading Platform Tools..."
          curl -L -o downloads/platform-tools.zip \
            "https://dl.google.com/android/repository/platform-tools_r35.0.1-windows.zip"

      - name: Validate Platform Tools
        run: |
          echo "Validating Platform Tools..."
          file_size=$(stat -c%s downloads/platform-tools.zip)
          if [ $file_size -lt 5000000 ]; then
            echo "ERROR: Platform Tools file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/platform-tools.zip > /dev/null 2>&1; then
            echo "ERROR: Platform Tools ZIP integrity check failed"
            exit 1
          fi
          echo "Platform Tools validation passed"

      - name: Upload Platform Tools
        uses: actions/upload-artifact@v4
        with:
          name: platform-tools
          path: downloads/platform-tools.zip

      # Build Tools Download
      - name: Download Build Tools 33.0.2
        run: |
          echo "Downloading Build Tools 33.0.2..."
          curl -L -o downloads/build-tools-33.0.2.zip \
            "https://dl.google.com/android/repository/build-tools_r33.0.2-windows.zip"

      - name: Validate Build Tools
        run: |
          echo "Validating Build Tools..."
          file_size=$(stat -c%s downloads/build-tools-33.0.2.zip)
          if [ $file_size -lt 30000000 ]; then
            echo "ERROR: Build Tools file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/build-tools-33.0.2.zip > /dev/null 2>&1; then
            echo "ERROR: Build Tools ZIP integrity check failed"
            exit 1
          fi
          echo "Build Tools validation passed"

      - name: Upload Build Tools
        uses: actions/upload-artifact@v4
        with:
          name: build-tools-33.0.2
          path: downloads/build-tools-33.0.2.zip

      # SDK Platform API 33 Download
      - name: Download SDK Platform API 33
        run: |
          echo "Downloading SDK Platform API 33..."
          curl -L -o downloads/sdk-platform-33.zip \
            "https://dl.google.com/android/repository/platform-33_r03.zip"

      - name: Validate SDK Platform API 33
        run: |
          echo "Validating SDK Platform API 33..."
          file_size=$(stat -c%s downloads/sdk-platform-33.zip)
          if [ $file_size -lt 30000000 ]; then
            echo "ERROR: SDK Platform API 33 file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/sdk-platform-33.zip > /dev/null 2>&1; then
            echo "ERROR: SDK Platform API 33 ZIP integrity check failed"
            exit 1
          fi
          echo "SDK Platform API 33 validation passed"

      - name: Upload SDK Platform API 33
        uses: actions/upload-artifact@v4
        with:
          name: sdk-platform-33
          path: downloads/sdk-platform-33.zip

      # SDK Platform API 30 Download
      - name: Download SDK Platform API 30
        run: |
          echo "Downloading SDK Platform API 30..."
          curl -L -o downloads/sdk-platform-30.zip \
            "https://dl.google.com/android/repository/platform-30_r03.zip"

      - name: Validate SDK Platform API 30
        run: |
          echo "Validating SDK Platform API 30..."
          file_size=$(stat -c%s downloads/sdk-platform-30.zip)
          if [ $file_size -lt 30000000 ]; then
            echo "ERROR: SDK Platform API 30 file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/sdk-platform-30.zip > /dev/null 2>&1; then
            echo "ERROR: SDK Platform API 30 ZIP integrity check failed"
            exit 1
          fi
          echo "SDK Platform API 30 validation passed"

      - name: Upload SDK Platform API 30
        uses: actions/upload-artifact@v4
        with:
          name: sdk-platform-30
          path: downloads/sdk-platform-30.zip

      # SDK Platform API 27 Download
      - name: Download SDK Platform API 27
        run: |
          echo "Downloading SDK Platform API 27..."
          curl -L -o downloads/sdk-platform-27.zip \
            "https://dl.google.com/android/repository/platform-27_r03.zip"

      - name: Validate SDK Platform API 27
        run: |
          echo "Validating SDK Platform API 27..."
          file_size=$(stat -c%s downloads/sdk-platform-27.zip)
          if [ $file_size -lt 25000000 ]; then
            echo "ERROR: SDK Platform API 27 file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/sdk-platform-27.zip > /dev/null 2>&1; then
            echo "ERROR: SDK Platform API 27 ZIP integrity check failed"
            exit 1
          fi
          echo "SDK Platform API 27 validation passed"

      - name: Upload SDK Platform API 27
        uses: actions/upload-artifact@v4
        with:
          name: sdk-platform-27
          path: downloads/sdk-platform-27.zip

      # System Image API 33 Download
      - name: Download System Image API 33
        run: |
          echo "Downloading System Image API 33..."
          curl -L -o downloads/sysimage-google-apis-x86_64-33.zip \
            "https://dl.google.com/android/repository/sys-img/google_apis/x86_64-33_r15.zip"

      - name: Validate System Image API 33
        run: |
          echo "Validating System Image API 33..."
          file_size=$(stat -c%s downloads/sysimage-google-apis-x86_64-33.zip)
          if [ $file_size -lt 500000000 ]; then
            echo "ERROR: System Image API 33 file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/sysimage-google-apis-x86_64-33.zip > /dev/null 2>&1; then
            echo "ERROR: System Image API 33 ZIP integrity check failed"
            exit 1
          fi
          echo "System Image API 33 validation passed"

      - name: Upload System Image API 33
        uses: actions/upload-artifact@v4
        with:
          name: sysimage-google-apis-x86_64-33
          path: downloads/sysimage-google-apis-x86_64-33.zip

      # Android M2Repository Download
      - name: Download Android M2Repository
        run: |
          echo "Downloading Android M2Repository..."
          curl -L -o downloads/android-m2repository.zip \
            "https://dl.google.com/android/repository/android_m2repository_r47.zip"

      - name: Validate Android M2Repository
        run: |
          echo "Validating Android M2Repository..."
          file_size=$(stat -c%s downloads/android-m2repository.zip)
          if [ $file_size -lt 100000000 ]; then
            echo "ERROR: Android M2Repository file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/android-m2repository.zip > /dev/null 2>&1; then
            echo "ERROR: Android M2Repository ZIP integrity check failed"
            exit 1
          fi
          echo "Android M2Repository validation passed"

      - name: Upload Android M2Repository
        uses: actions/upload-artifact@v4
        with:
          name: android-m2repository
          path: downloads/android-m2repository.zip

      # Google M2Repository Download
      - name: Download Google M2Repository
        run: |
          echo "Downloading Google M2Repository..."
          curl -L -o downloads/google-m2repository.zip \
            "https://dl.google.com/android/repository/google_m2repository_gms_v11_3_rc05_wear_2_0_7.zip"

      - name: Validate Google M2Repository
        run: |
          echo "Validating Google M2Repository..."
          file_size=$(stat -c%s downloads/google-m2repository.zip)
          if [ $file_size -lt 50000000 ]; then
            echo "ERROR: Google M2Repository file too small ($file_size bytes)"
            exit 1
          fi
          if ! unzip -t downloads/google-m2repository.zip > /dev/null 2>&1; then
            echo "ERROR: Google M2Repository ZIP integrity check failed"
            exit 1
          fi
          echo "Google M2Repository validation passed"

      - name: Upload Google M2Repository
        uses: actions/upload-artifact@v4
        with:
          name: google-m2repository
          path: downloads/google-m2repository.zip

      # Final Summary
      - name: Download Summary
        run: |
          echo "=== Download Summary ==="
          echo "All Android development components downloaded and validated successfully:"
          echo "- JDK 17 (Windows x64)"
          echo "- Gradle 8.0.2"
          echo "- Android Command Line Tools"
          echo "- Platform Tools"
          echo "- Build Tools 33.0.2"
          echo "- SDK Platform API 33, 30, 27"
          echo "- System Image API 33 (Google APIs x86_64)"
          echo "- Android M2Repository"
          echo "- Google M2Repository"
          echo ""
          echo "All files have been validated for:"
          echo "- Minimum file size requirements"
          echo "- ZIP integrity"
          echo "- Upload as separate artifacts"
          echo ""
          echo "Ready for offline Android development setup!"