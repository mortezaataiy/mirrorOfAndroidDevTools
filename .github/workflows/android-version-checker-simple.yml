name: Android Version Compatibility Checker Simple

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (Normal, Verbose, DryRun)'
        required: false
        default: 'Verbose'
        type: choice
        options:
        - Normal
        - Verbose
        - DryRun

jobs:
  android-compatibility-test:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell execution policy
      shell: powershell
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        Write-Host "PowerShell execution policy set to RemoteSigned" -ForegroundColor Green

    - name: Create downloads directory
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path ".\.ignoredDownloads" -Force
        Write-Host "Downloads directory created" -ForegroundColor Green

    - name: Download JDK for testing
      shell: powershell
      run: |
        Write-Host "Downloading JDK 17..." -ForegroundColor Cyan
        try {
          Invoke-WebRequest -Uri "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.13%2B11/OpenJDK17U-jdk_x64_windows_hotspot_17.0.13_11.zip" -OutFile ".\.ignoredDownloads\jdk-17.zip" -TimeoutSec 300
          $fileSize = (Get-Item ".\.ignoredDownloads\jdk-17.zip").Length
          Write-Host "JDK downloaded successfully (Size: $([math]::Round($fileSize/1MB, 2)) MB)" -ForegroundColor Green
        } catch {
          Write-Warning "Error downloading JDK: $($_.Exception.Message)"
        }

    - name: Test Enhanced PowerShell Script
      shell: powershell
      run: |
        Write-Host "Testing Enhanced PowerShell Script..." -ForegroundColor Cyan
        
        # Test script parameters
        $scriptParams = @{
          Mode = "${{ github.event.inputs.test_mode || 'DryRun' }}"
          InstallPath = "D:\Android"
          SourcePath = ".\.ignoredDownloads"
          CheckOnly = $true
        }
        
        Write-Host "Script parameters:" -ForegroundColor Yellow
        $scriptParams | Format-Table -AutoSize
        
        try {
          # Run the enhanced script in check-only mode
          & ".\auto-download-and-setup-android-offline.ps1" @scriptParams
          
          Write-Host "Script test completed successfully" -ForegroundColor Green
        }
        catch {
          Write-Host "Script test failed: $($_.Exception.Message)" -ForegroundColor Red
          throw
        }

    - name: Generate test summary
      shell: powershell
      run: |
        Write-Host "Generating test summary..." -ForegroundColor Cyan
        
        $summary = @"
# Android Version Compatibility Checker Test Results

## Test Execution
- **Date**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- **Environment**: Windows (GitHub Actions)
- **Run ID**: $env:GITHUB_RUN_ID
- **Test Mode**: ${{ github.event.inputs.test_mode || 'DryRun' }}

## Results
- Enhanced PowerShell script integration: PASSED
- Component detection: TESTED
- Workflow execution: SUCCESSFUL

## Next Steps
- Full installation test with all components
- APK generation validation
- Production deployment

"@
        
        New-Item -ItemType Directory -Path "reports" -Force
        $summary | Out-File -FilePath "reports\test-summary.md" -Encoding UTF8
        Write-Host "Test summary generated" -ForegroundColor Green

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-version-checker-simple-results
        path: |
          reports/
        retention-days: 7