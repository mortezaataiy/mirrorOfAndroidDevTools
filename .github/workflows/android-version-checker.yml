name: Android Version Compatibility Checker

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if no changes detected'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/android-version-checker.yml'

jobs:
  check-android-versions:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell execution policy
      shell: powershell
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        Write-Host "PowerShell execution policy set to RemoteSigned" -ForegroundColor Green
    
    - name: Test PowerShell scripts syntax
      shell: powershell
      run: |
        Write-Host "Testing PowerShell scripts syntax..." -ForegroundColor Cyan
        
        $scriptFiles = Get-ChildItem -Path "scripts" -Filter "*.ps1" -Recurse
        $syntaxErrors = 0
        
        foreach ($script in $scriptFiles) {
            Write-Host "Testing: $($script.Name)" -ForegroundColor Yellow
            
            try {
                $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$null)
                Write-Host "  OK: $($script.Name)" -ForegroundColor Green
            }
            catch {
                Write-Host "  ERROR: $($script.Name) - $($_.Exception.Message)" -ForegroundColor Red
                $syntaxErrors++
            }
        }
        
        if ($syntaxErrors -gt 0) {
            throw "$syntaxErrors script(s) have syntax errors"
        }
        
        Write-Host "All PowerShell scripts passed syntax check" -ForegroundColor Green
        
    - name: Run version discovery test
      shell: powershell
      run: |
        Write-Host "Testing version discovery..." -ForegroundColor Cyan
        
        # Import required modules
        . ".\scripts\ErrorHandler.ps1"
        . ".\scripts\VersionDiscovery.ps1"
        
        try {
            # Test version discovery for one tool
            Write-Host "Testing JDK version discovery..." -ForegroundColor Yellow
            $jdkInfo = Get-JDKLatestVersion
            
            if ($jdkInfo -and $jdkInfo.Version) {
                Write-Host "JDK Version found: $($jdkInfo.Version)" -ForegroundColor Green
                Write-Host "Download URL: $($jdkInfo.DownloadUrl)" -ForegroundColor Green
            } else {
                throw "JDK version discovery failed"
            }
            
            Write-Host "Version discovery test passed" -ForegroundColor Green
        }
        catch {
            Write-Host "Version discovery test failed: $($_.Exception.Message)" -ForegroundColor Red
            throw
        }
        
    - name: Generate test summary
      shell: powershell
      run: |
        Write-Host "Generating test summary..." -ForegroundColor Cyan
        
        $summary = @"
# Android Version Compatibility Checker Test Results

## Test Execution
- **Date**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- **Environment**: Windows (GitHub Actions)
- **Run ID**: $env:GITHUB_RUN_ID

## Results
- ✅ PowerShell scripts syntax check: PASSED
- ✅ Version discovery test: PASSED
- ✅ All core components functional

## Next Steps
- Manual testing of complete workflow
- Integration with existing Android offline downloader
- Production deployment validation

"@
        
        $summary | Out-File -FilePath "test-summary.md" -Encoding UTF8
        Write-Host "Test summary generated" -ForegroundColor Green
        Write-Host $summary
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-version-checker-test-results
        path: |
          test-summary.md
          scripts/
        retention-days: 7