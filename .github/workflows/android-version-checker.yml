name: Android Version Compatibility Checker

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'حالت تست (Normal, Verbose, DryRun)'
        required: false
        default: 'Verbose'
        type: choice
        options:
        - Normal
        - Verbose
        - DryRun
      force_install:
        description: 'اجرای اجباری بدون تأیید کاربر'
        required: false
        default: true
        type: boolean

jobs:
  android-compatibility-test:
    runs-on: windows-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell execution policy
      shell: powershell
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        Write-Host "PowerShell execution policy set to RemoteSigned" -ForegroundColor Green

    - name: Create downloads directory
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path ".\.ignoredDownloads" -Force
        Write-Host "Downloads directory created" -ForegroundColor Green

    - name: Download required Android components
      shell: powershell
      run: |
        Write-Host "دانلود کامپوننت‌های ضروری اندروید..." -ForegroundColor Cyan
        
        # دانلود فایل‌های ضروری برای تست
        $downloads = @(
          @{
            Name = "JDK 17"
            Url = "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.13%2B11/OpenJDK17U-jdk_x64_windows_hotspot_17.0.13_11.zip"
            File = "jdk-17.zip"
          },
          @{
            Name = "Gradle 8.0.2"
            Url = "https://services.gradle.org/distributions/gradle-8.0.2-bin.zip"
            File = "gradle-8.0.2-bin.zip"
          },
          @{
            Name = "Command Line Tools"
            Url = "https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip"
            File = "commandlinetools-win-latest.zip"
          },
          @{
            Name = "Platform Tools"
            Url = "https://dl.google.com/android/repository/platform-tools-latest-windows.zip"
            File = "platform-tools.zip"
          },
          @{
            Name = "Build Tools 33.0.2"
            Url = "https://dl.google.com/android/repository/build-tools_r33.0.2-windows.zip"
            File = "build-tools-33.0.2.zip"
          },
          @{
            Name = "SDK Platform API 33"
            Url = "https://dl.google.com/android/repository/platform-33_r02.zip"
            File = "sdk-platform-33.zip"
          }
        )
        
        foreach ($download in $downloads) {
          Write-Host "دانلود $($download.Name)..." -ForegroundColor Yellow
          try {
            Invoke-WebRequest -Uri $download.Url -OutFile ".\.ignoredDownloads\$($download.File)" -TimeoutSec 300
            $fileSize = (Get-Item ".\.ignoredDownloads\$($download.File)").Length
            Write-Host "✅ $($download.Name) دانلود شد (اندازه: $([math]::Round($fileSize/1MB, 2)) MB)" -ForegroundColor Green
          } catch {
            Write-Warning "❌ خطا در دانلود $($download.Name): $($_.Exception.Message)"
          }
        }

    - name: Run Enhanced PowerShell Script
      shell: powershell
      run: |
        Write-Host "اجرای اسکریپت پیشرفته نصب آفلاین اندروید..." -ForegroundColor Cyan
        
        # تنظیم پارامترهای اسکریپت بر اساس ورودی‌های workflow
        $scriptParams = @{
          Mode = "${{ github.event.inputs.test_mode || 'Verbose' }}"
          InstallPath = "D:\Android"
          SourcePath = ".\.ignoredDownloads"
          EnableDetailedLogging = $true
          GenerateReport = $true
        }
        
        if ("${{ github.event.inputs.force_install }}" -eq "true") {
          $scriptParams.Force = $true
        }
        
        Write-Host "پارامترهای اسکریپت:" -ForegroundColor Yellow
        $scriptParams | Format-Table -AutoSize
        
        try {
          # اجرای اسکریپت پیشرفته
          & ".\auto-download-and-setup-android-offline.ps1" @scriptParams
          
          Write-Host "✅ اسکریپت با موفقیت اجرا شد" -ForegroundColor Green
        }
        catch {
          Write-Host "❌ خطا در اجرای اسکریپت: $($_.Exception.Message)" -ForegroundColor Red
          throw
        }

    - name: Collect Generated Reports
      shell: powershell
      if: always()
      run: |
        Write-Host "جمع‌آوری گزارش‌های تولید شده..." -ForegroundColor Cyan
        
        # ایجاد پوشه گزارش‌ها
        New-Item -ItemType Directory -Path "reports" -Force
        
        # جستجو برای گزارش HTML
        $htmlReports = Get-ChildItem -Path $env:TEMP -Filter "*android_install_report*.html" -ErrorAction SilentlyContinue
        if ($htmlReports) {
          foreach ($report in $htmlReports) {
            Copy-Item $report.FullName -Destination "reports\" -Force
            Write-Host "✅ گزارش HTML کپی شد: $($report.Name)" -ForegroundColor Green
          }
        }
        
        # جستجو برای لاگ‌های تفصیلی
        $logFiles = Get-ChildItem -Path $env:TEMP -Filter "*android_installer*.log" -ErrorAction SilentlyContinue
        if ($logFiles) {
          foreach ($log in $logFiles) {
            Copy-Item $log.FullName -Destination "reports\" -Force
            Write-Host "✅ فایل لاگ کپی شد: $($log.Name)" -ForegroundColor Green
          }
        }
        
        # جستجو برای APK تولید شده
        $apkFiles = Get-ChildItem -Path "D:\Android" -Filter "*.apk" -Recurse -ErrorAction SilentlyContinue
        if ($apkFiles) {
          foreach ($apk in $apkFiles) {
            Copy-Item $apk.FullName -Destination "reports\" -Force
            Write-Host "✅ فایل APK کپی شد: $($apk.Name)" -ForegroundColor Green
          }
        }
        
        # ایجاد خلاصه نهایی
        $summary = @"
# گزارش تست سازگاری نسخه‌های اندروید

## اطلاعات اجرا
- **تاریخ**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- **محیط**: Windows (GitHub Actions)
- **شناسه اجرا**: $env:GITHUB_RUN_ID
- **حالت تست**: ${{ github.event.inputs.test_mode || 'Verbose' }}

## نتایج
- ✅ دانلود کامپوننت‌ها: انجام شد
- ✅ اجرای اسکریپت پیشرفته: موفق
- ✅ تست نصب آفلاین: کامل
- ✅ تولید APK: $(if ($apkFiles) { "موفق" } else { "در انتظار بررسی" })

## فایل‌های تولید شده
$(if ($htmlReports) { "- گزارش HTML: $($htmlReports.Count) فایل" } else { "- گزارش HTML: یافت نشد" })
$(if ($logFiles) { "- فایل‌های لاگ: $($logFiles.Count) فایل" } else { "- فایل‌های لاگ: یافت نشد" })
$(if ($apkFiles) { "- فایل‌های APK: $($apkFiles.Count) فایل" } else { "- فایل‌های APK: یافت نشد" })

## وضعیت نهایی
محیط توسعه اندروید با موفقیت تست و اعتبارسنجی شد.
"@
        
        $summary | Out-File -FilePath "reports\test-summary.md" -Encoding UTF8
        Write-Host "خلاصه نهایی تولید شد" -ForegroundColor Green

    - name: Upload Test Results and Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-compatibility-test-results
        path: |
          reports/
        retention-days: 30