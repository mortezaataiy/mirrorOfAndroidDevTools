name: Quick Test - Platform Tools & Google M2Repository

on:
  workflow_dispatch:

jobs:
  quick-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test directory
        run: mkdir -p test_downloads

      - name: Test Platform Tools URLs
        run: |
          echo "=== ØªØ³Øª Ø³Ø±ÛŒØ¹ Platform Tools ==="
          
          urls=(
            "https://dl.google.com/android/repository/platform-tools-latest-windows.zip"
            "https://dl.google.com/android/repository/platform-tools_r34.0.5-windows.zip"
            "https://dl.google.com/android/repository/platform-tools_r33.0.2-windows.zip"
            "https://dl.google.com/android/repository/platform-tools_r35.0.1-windows.zip"
          )
          
          best_url=""
          best_size=0
          
          for url in "${urls[@]}"; do
            echo "ØªØ³Øª: $url"
            if curl -L -o "test_downloads/platform-test.zip" "$url" --max-time 60; then
              size=$(stat -c%s "test_downloads/platform-test.zip")
              echo "  Ø§Ù†Ø¯Ø§Ø²Ù‡: $size bytes"
              
              # Ø¨Ø±Ø±Ø³ÛŒ HTML
              if head -c 1024 "test_downloads/platform-test.zip" | grep -qi -E '(<html|<!DOCTYPE|<head|<body)'; then
                echo "  âŒ Ù…Ø­ØªÙˆØ§ÛŒ HTML"
              else
                # Ø¨Ø±Ø±Ø³ÛŒ ZIP
                if unzip -t "test_downloads/platform-test.zip" > /dev/null 2>&1; then
                  echo "  âœ… ZIP Ù…Ø¹ØªØ¨Ø±"
                  if [ $size -gt $best_size ]; then
                    best_size=$size
                    best_url=$url
                  fi
                else
                  echo "  âŒ ZIP Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                fi
              fi
              rm -f "test_downloads/platform-test.zip"
            else
              echo "  âŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø§Ú©Ø§Ù…"
            fi
          done
          
          if [ -n "$best_url" ]; then
            echo "PLATFORM_TOOLS_URL=$best_url" >> $GITHUB_ENV
            echo "PLATFORM_TOOLS_SIZE=$best_size" >> $GITHUB_ENV
            echo "âœ… Ø¨Ù‡ØªØ±ÛŒÙ† URL Ø¨Ø±Ø§ÛŒ Platform Tools: $best_url (Ø§Ù†Ø¯Ø§Ø²Ù‡: $best_size bytes)"
          else
            echo "âŒ Ù‡ÛŒÚ† URL Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ Platform Tools Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯"
          fi

      - name: Test Google M2Repository with Maven Central
        run: |
          echo "=== ØªØ³Øª Ø³Ø±ÛŒØ¹ Google M2Repository Ø§Ø² Maven Central ==="
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ Ù…ÙˆÙ‚Øª
          mkdir -p test_downloads/maven_temp
          
          # ØªØ³Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
          libraries=(
            "com/google/android/gms/play-services-base/18.2.0/play-services-base-18.2.0.aar"
            "com/google/android/gms/play-services-basement/18.2.0/play-services-basement-18.2.0.aar"
            "com/google/android/gms/play-services-tasks/18.0.2/play-services-tasks-18.0.2.aar"
          )
          
          success_count=0
          total_size=0
          
          for lib in "${libraries[@]}"; do
            lib_name=$(basename "$lib")
            echo "ØªØ³Øª: $lib_name"
            
            if curl -L -o "test_downloads/maven_temp/$lib_name" "https://maven.google.com/$lib" --max-time 60; then
              size=$(stat -c%s "test_downloads/maven_temp/$lib_name")
              echo "  Ø§Ù†Ø¯Ø§Ø²Ù‡: $size bytes"
              
              if [ $size -gt 10000 ]; then  # Ø¨ÛŒØ´ØªØ± Ø§Ø² 10KB
                success_count=$((success_count + 1))
                total_size=$((total_size + size))
                echo "  âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚"
              else
                echo "  âŒ ÙØ§ÛŒÙ„ Ú©ÙˆÚ†Ú©"
                rm -f "test_downloads/maven_temp/$lib_name"
              fi
            else
              echo "  âŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø§Ú©Ø§Ù…"
            fi
          done
          
          if [ $success_count -gt 0 ]; then
            # Ø§ÛŒØ¬Ø§Ø¯ ZIP ØªØ³Øª
            cd test_downloads/maven_temp
            zip -r ../google-m2repo-test.zip . > /dev/null 2>&1
            cd ../..
            
            zip_size=$(stat -c%s "test_downloads/google-m2repo-test.zip")
            
            echo "GOOGLE_M2REPO_URL=https://maven.google.com" >> $GITHUB_ENV
            echo "GOOGLE_M2REPO_SIZE=$zip_size" >> $GITHUB_ENV
            echo "GOOGLE_M2REPO_COUNT=$success_count" >> $GITHUB_ENV
            
            echo "âœ… Google M2Repository Ø§Ø² Maven Central Ù…ÙˆÙÙ‚"
            echo "   Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: $success_count"
            echo "   Ø§Ù†Ø¯Ø§Ø²Ù‡ ZIP: $zip_size bytes"
            
            rm -f test_downloads/google-m2repo-test.zip
          else
            echo "âŒ Ù‡ÛŒÚ† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø² Maven Central Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø´Ø¯"
          fi
          
          # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ´Ù‡ Ù…ÙˆÙ‚Øª
          rm -rf test_downloads/maven_temp

      - name: Test Alternative Google M2Repository Sources
        run: |
          echo "=== ØªØ³Øª Ù…Ù†Ø§Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Google M2Repository ==="
          
          # ØªØ³Øª URL Ù‡Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
          alt_urls=(
            "https://dl.google.com/android/repository/google_m2repository_r47.zip"
            "https://repo1.maven.org/maven2/com/google/android/gms/play-services/17.0.0/play-services-17.0.0.aar"
            "https://jcenter.bintray.com/com/google/android/gms/play-services/17.0.0/play-services-17.0.0.aar"
          )
          
          for url in "${alt_urls[@]}"; do
            echo "ØªØ³Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: $url"
            
            if [[ "$url" == *".zip" ]]; then
              # ØªØ³Øª ÙØ§ÛŒÙ„ ZIP
              if curl -L -o "test_downloads/alt-test.zip" "$url" --max-time 60; then
                size=$(stat -c%s "test_downloads/alt-test.zip")
                echo "  Ø§Ù†Ø¯Ø§Ø²Ù‡: $size bytes"
                
                if [ $size -gt 1000000 ]; then  # Ø¨ÛŒØ´ØªØ± Ø§Ø² 1MB
                  if ! head -c 1024 "test_downloads/alt-test.zip" | grep -qi -E '(<html|<!DOCTYPE|<head|<body)'; then
                    if unzip -t "test_downloads/alt-test.zip" > /dev/null 2>&1; then
                      echo "  âœ… ZIP Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ¯Ø§ Ø´Ø¯!"
                      echo "GOOGLE_M2REPO_ALT_URL=$url" >> $GITHUB_ENV
                      echo "GOOGLE_M2REPO_ALT_SIZE=$size" >> $GITHUB_ENV
                    else
                      echo "  âŒ ZIP Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                    fi
                  else
                    echo "  âŒ Ù…Ø­ØªÙˆØ§ÛŒ HTML"
                  fi
                else
                  echo "  âŒ ÙØ§ÛŒÙ„ Ú©ÙˆÚ†Ú©"
                fi
                rm -f "test_downloads/alt-test.zip"
              else
                echo "  âŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø§Ú©Ø§Ù…"
              fi
            else
              # ØªØ³Øª ÙØ§ÛŒÙ„ AAR
              if curl -L -o "test_downloads/alt-test.aar" "$url" --max-time 60; then
                size=$(stat -c%s "test_downloads/alt-test.aar")
                echo "  Ø§Ù†Ø¯Ø§Ø²Ù‡: $size bytes"
                
                if [ $size -gt 50000 ]; then  # Ø¨ÛŒØ´ØªØ± Ø§Ø² 50KB
                  echo "  âœ… AAR Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø¹ØªØ¨Ø±"
                else
                  echo "  âŒ AAR Ú©ÙˆÚ†Ú©"
                fi
                rm -f "test_downloads/alt-test.aar"
              else
                echo "  âŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø§Ú©Ø§Ù…"
              fi
            fi
          done

      - name: Generate Quick Test Results
        run: |
          echo "=== Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ø³Ø±ÛŒØ¹ ==="
          echo ""
          
          echo "ğŸ”§ Platform Tools:"
          if [ -n "${PLATFORM_TOOLS_URL:-}" ]; then
            echo "  âœ… URL Ù…Ø¹ØªØ¨Ø±: ${PLATFORM_TOOLS_URL}"
            echo "  ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡: ${PLATFORM_TOOLS_SIZE} bytes"
          else
            echo "  âŒ URL Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯"
          fi
          
          echo ""
          echo "ğŸ”§ Google M2Repository:"
          if [ -n "${GOOGLE_M2REPO_URL:-}" ]; then
            echo "  âœ… Maven Central: ${GOOGLE_M2REPO_URL}"
            echo "  ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡: ${GOOGLE_M2REPO_SIZE} bytes"
            echo "  ğŸ“¦ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§: ${GOOGLE_M2REPO_COUNT}"
          fi
          
          if [ -n "${GOOGLE_M2REPO_ALT_URL:-}" ]; then
            echo "  âœ… Ù…Ù†Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: ${GOOGLE_M2REPO_ALT_URL}"
            echo "  ğŸ“ Ø§Ù†Ø¯Ø§Ø²Ù‡: ${GOOGLE_M2REPO_ALT_SIZE} bytes"
          fi
          
          if [ -z "${GOOGLE_M2REPO_URL:-}" ] && [ -z "${GOOGLE_M2REPO_ALT_URL:-}" ]; then
            echo "  âŒ Ù‡ÛŒÚ† Ù…Ù†Ø¨Ø¹ Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯"
          fi
          
          echo ""
          echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡:"
          components_fixed=0
          
          if [ -n "${PLATFORM_TOOLS_URL:-}" ]; then
            components_fixed=$((components_fixed + 1))
          fi
          
          if [ -n "${GOOGLE_M2REPO_URL:-}" ] || [ -n "${GOOGLE_M2REPO_ALT_URL:-}" ]; then
            components_fixed=$((components_fixed + 1))
          fi
          
          echo "  ğŸ¯ Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø±ÙØ¹: $components_fixed Ø§Ø² 2"
          
          if [ $components_fixed -eq 2 ]; then
            echo "  ğŸ‰ Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Ù‚Ø§Ø¨Ù„ Ø±ÙØ¹ Ø§Ø³Øª!"
          else
            echo "  âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÛŒØ´ØªØ±"
          fi

      - name: Create patch instructions
        run: |
          cat << 'EOF' > quick_patch_instructions.md
          # Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø³Ø±ÛŒØ¹ Ø§ØµÙ„Ø§Ø­
          
          ## Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ø³Ø±ÛŒØ¹
          
          EOF
          
          if [ -n "${PLATFORM_TOOLS_URL:-}" ]; then
            echo "### âœ… Platform Tools" >> quick_patch_instructions.md
            echo "- URL: \`${PLATFORM_TOOLS_URL}\`" >> quick_patch_instructions.md
            echo "- Ø§Ù†Ø¯Ø§Ø²Ù‡: ${PLATFORM_TOOLS_SIZE} bytes" >> quick_patch_instructions.md
            echo "- Ø­Ø¯Ø§Ù‚Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: 5MB" >> quick_patch_instructions.md
            echo "" >> quick_patch_instructions.md
          fi
          
          if [ -n "${GOOGLE_M2REPO_URL:-}" ]; then
            echo "### âœ… Google M2Repository (Maven Central)" >> quick_patch_instructions.md
            echo "- URL: \`${GOOGLE_M2REPO_URL}\`" >> quick_patch_instructions.md
            echo "- Ø§Ù†Ø¯Ø§Ø²Ù‡: ${GOOGLE_M2REPO_SIZE} bytes" >> quick_patch_instructions.md
            echo "- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§: ${GOOGLE_M2REPO_COUNT}" >> quick_patch_instructions.md
            echo "" >> quick_patch_instructions.md
          fi
          
          if [ -n "${GOOGLE_M2REPO_ALT_URL:-}" ]; then
            echo "### âœ… Google M2Repository (Ù…Ù†Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)" >> quick_patch_instructions.md
            echo "- URL: \`${GOOGLE_M2REPO_ALT_URL}\`" >> quick_patch_instructions.md
            echo "- Ø§Ù†Ø¯Ø§Ø²Ù‡: ${GOOGLE_M2REPO_ALT_SIZE} bytes" >> quick_patch_instructions.md
            echo "" >> quick_patch_instructions.md
          fi
          
          echo "## Ø§Ø¹Ù…Ø§Ù„ Ø¯Ø± workflow Ø§ØµÙ„ÛŒ" >> quick_patch_instructions.md
          echo "1. Platform Tools URL Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯" >> quick_patch_instructions.md
          echo "2. Google M2Repository Ø±Ø§ Ø¨Ø§ Ø±ÙˆØ´ Ù…ÙˆÙÙ‚ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯" >> quick_patch_instructions.md
          echo "3. Ø­Ø¯Ø§Ù‚Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯" >> quick_patch_instructions.md

      - name: Upload quick test results
        uses: actions/upload-artifact@v4
        with:
          name: quick-test-results
          path: quick_patch_instructions.md
          retention-days: 7